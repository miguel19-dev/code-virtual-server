<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CallBlue</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--glass:rgba(255,255,255,0.08);--accent:#60a5fa;--green:#34d399;--red:#ef4444;--text:#e2e8f0}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1e293b,#0f172a);color:white;min-height:100vh;overflow:hidden}
    .main{max-width:420px;margin:0 auto;padding:20px;height:100vh;display:flex;flex-direction:column;position:relative}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    h1{font-size:32px;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logout{background:var(--glass);width:50px;height:50px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:.3s}
    .logout:hover{background:var(--red);transform:scale(1.1)}
    .users{flex:1;overflow-y:auto;padding-bottom:20px}
    .user{background:var(--glass);backdrop-filter:blur(16px);border-radius:24px;padding:18px;margin-bottom:16px;display:flex;align-items:center;gap:18px;border:1px solid rgba(255,255,255,0.1);transition:.3s}
    .user:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,0.4)}
    .user img{width:64px;height:64px;border-radius:50%;object-fit:cover;border:4px solid var(--accent);box-shadow:0 8px 20px rgba(0,0,0,0.5)}
    .name{font-size:18px;font-weight:600}
    .online{color:#94a3b8;font-size:14px}
    .call-btn{background:linear-gradient(45deg,var(--accent),var(--green));width:58px;height:58px;border-radius:50%;border:none;cursor:pointer;display:grid;place-items:center;box-shadow:0 8px 25px rgba(96,165,250,0.5);transition:.3s}
    .call-btn:hover{transform:scale(1.15)}

    .call-screen{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;gap:30px;z-index:999}
    .call-screen.active{display:flex;animation:fade .5s}
    @keyframes fade{from{opacity:0}to{opacity:1}}
    .big-avatar{width:180px;height:180px;border-radius:50%;border:8px solid var(--accent);object-fit:cover;box-shadow:0 30px 60px rgba(0,0,0,0.7)}
    .calling-name{font-size:36px;font-weight:700}
    .status{font-size:20px;color:#94a3b8}
    .timer{font-size:56px;color:var(--green);font-weight:700;display:none}
    .actions{display:flex;gap:80px;margin-top:50px}
    .btn{width:90px;height:90px;border-radius:50%;border:none;cursor:pointer;display:grid;place-items:center;box-shadow:0 15px 35px rgba(0,0,0,0.6);transition:.3s}
    .btn:hover{transform:scale(1.1)}
    .accept{background:var(--green)}
    .reject,.hangup{background:var(--red)}
  </style>
</head>
<body>

<audio id="remoteAudio" autoplay playsinline></audio>

<div class="main">
  <header>
    <h1>CallBlue</h1>
    <div class="logout" onclick="localStorage.removeItem('currentUser');location.href='/'">
      <svg width="28" height="28" fill="white" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
    </div>
  </header>
  <div class="users" id="usersList"></div>
</div>

<div id="incoming" class="call-screen">
  <img id="inAvatar" class="big-avatar" src="">
  <div class="calling-name" id="inName"></div>
  <div class="status">Llamada entrante...</div>
  <div class="actions">
    <button class="btn accept" id="acceptBtn">Accept</button>
    <button class="btn reject" id="rejectBtn">Reject</button>
  </div>
</div>

<div id="activeCall" class="call-screen">
  <img id="callAvatar" class="big-avatar" src="">
  <div class="calling-name" id="callName"></div>
  <div class="status" id="callStatus">Conectando...</div>
  <div class="timer" id="timer">00:00</div>
  <button class="btn hangup" id="hangupBtn">Hangup</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!user) location.href = '/';

  let pc = null;
  let callActive = false;
  let timerSeconds = 0;
  let timerInterval = null;

  socket.emit('login', user);

  socket.on('online-users', list => {
    const container = document.getElementById('usersList');
    container.innerHTML = '';
    list.filter(u => u.id !== user.id).forEach(u => {
      const div = document.createElement('div');
      div.className = 'user';
      div.innerHTML = `
        <img src="${u.avatar}" onerror="this.src='/default-avatar.png'">
        <div>
          <div class="name">${u.name}</div>
          <div class="online">En l√≠nea</div>
        </div>
        <button class="call-btn" onclick="callUser(\( {u.id}, ' \){u.name}', '${u.avatar}')">
          <svg width="28" height="28" fill="white" viewBox="0 0 24 24"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57a1 1 0 0 0-1.02.24l-2.2 2.2a15.045 15.045 0 0 1-6.59-6.59l2.2-2.2a1 1 0 0 0 .25-1.02A10.95 10.95 0 0 1 8.5 4a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1c0 9.39 7.61 17 17 17a1 1 0 0 0 1-1v-3.5a1 1 0 0 0-1-1z"/></svg>
        </button>
      `;
      container.appendChild(div);
    });
  });

  window.callUser = async (id, name, avatar) => {
    pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]});
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    pc.ontrack = e => document.getElementById('remoteAudio').srcObject = e.streams[0];
    pc.onicecandidate = e => e.candidate && socket.emit('webrtc-ice', {target: id, candidate: e.candidate});

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('call-user', {to: {id}, from: user});
    socket.emit('webrtc-offer', {target: id, offer});

    document.getElementById('callAvatar').src = avatar || '/default-avatar.png';
    document.getElementById('callName').textContent = name;
    document.getElementById('callStatus').textContent = 'Llamando...';
    document.getElementById('activeCall').classList.add('active');
    callActive = true;
  };

  socket.on('incoming-call', data => {
    document.getElementById('inAvatar').src = data.from.avatar || '/default-avatar.png';
    document.getElementById('inName').textContent = data.from.name;
    document.getElementById('incoming').classList.add('active');
  });

  document.getElementById('acceptBtn').onclick = () => {
    document.getElementById('incoming').classList.remove('active');
    document.getElementById('activeCall').classList.add('active');
    document.getElementById('callStatus').style.display = 'none';
    document.getElementById('timer').style.display = 'block';
    socket.emit('accept-call', user.id);
    startTimer();
  };

  document.getElementById('rejectBtn').onclick = () => {
    document.getElementById('incoming').classList.remove('active');
    socket.emit('end-call');
  };

  document.getElementById('hangupBtn').onclick = () => {
    endCall();
  };

  function startTimer() {
    timerSeconds = 0;
    timerInterval = setInterval(() => {
      timerSeconds++;
      const m = String(Math.floor(timerSeconds/60)).padStart(2,'0');
      const s = String(timerSeconds%60).padStart(2,'0');
      document.getElementById('timer').textContent = `\( {m}: \){s}`;
    }, 1000);
  }

  function endCall() {
    if (timerInterval) clearInterval(timerInterval);
    if (pc) pc.close();
    callActive = false;
    document.querySelectorAll('.call-screen').forEach(s => s.classList.remove('active'));
    socket.emit('end-call');
  }

  socket.on('call-accepted', () => {
    document.getElementById('callStatus').style.display = 'none';
    document.getElementById('timer').style.display = 'block';
    startTimer();
  });
</script>
</body>
</html>