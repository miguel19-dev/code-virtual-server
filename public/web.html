<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CallBlue</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:rgba(30,41,59,0.7);--accent:#60a5fa;--green:#34d399;--red:#ef4444}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#1e293b,#0f172a);color:#fff;min-height:100vh;margin:0;overflow:hidden}
    .container{max-width:420px;margin:0 auto;padding:20px;height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    h1{font-size:28px;background:linear-gradient(90deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logout{background:#ffffff22;padding:12px;border-radius:50%;cursor:pointer}
    .users{flex:1;overflow-y:auto}
    .user{background:var(--card);backdrop-filter:blur(12px);border-radius:16px;padding:16px;margin-bottom:12px;display:flex;align-items:center;gap:16px}
    .user img{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid var(--accent)}
    .call-btn{background:linear-gradient(45deg,var(--accent),var(--green));width:52px;height:52px;border-radius:50%;border:none;cursor:pointer}

    .screen{position:fixed;inset:0;background:var(--bg);display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px}
    .screen.active{display:flex}
    .big-avatar{width:160px;height:160px;border-radius:50%;border:6px solid var(--accent);object-fit:cover}
    .timer{font-size:48px;color:var(--green)}
    .btns{display:flex;gap:60px;margin-top:40px}
    .btn-circle{width:80px;height:80px;border-radius:50%;border:none;cursor:pointer;display:grid;place-items:center}
    .accept{background:var(--green)}
    .reject,.hangup{background:var(--red)}
  </style>
</head>
<body>

<audio id="remote" autoplay playsinline></audio>

<div class="container">
  <header>
    <h1>CallBlue</h1>
    <div class="logout" onclick="localStorage.clear();location.href='/'">
      <svg width="24" height="" fill="#fff" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.59L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
    </div>
  </header>
  <div class="users" id="users"></div>
</div>

<div id="incoming" class="screen">
  <img id="in-avatar" class="big-avatar" src="">
  <h2 id="in-name"></h2>
  <p>Llamada entrante...</p>
  <div class="btns">
    <button class="btn-circle accept" id="accept">
      <svg width="36" height="36" fill="#fff" viewBox="0 0 24 24"><path d="M20 15.5c-1.25 0-2.2-3.57-.57a1 1 0 0 0-1.02.24l-2.2 2.2a15 15 0 0 1-6.59-6.59l2.2-2.2a1 1 0 0 0 0 .25-1.02A11 11 0 0 1 8.5 4a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1c0 9.39 7.61 17 17 17a1 1 0 0 0 1-1v-3.5a1 1 0 0 0-1-1z"/></svg>
    </button>
    <button class="btn-circle reject" id="reject">
      <svg width="36" height="36" fill="#fff" viewBox="0 0 24 24"><path d="M12 9c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm5 13.59L15.59 21 12 17.41 8.41 21 7 19.59 10.59 16 7 12.41 8.41 11 12 14.59 15.59 11 17 12.41 13.41 16 17 19.59 15.59 21z"/></svg>
    </button>
  </div>
</div>

<div id="call" class="screen">
  <img id="call-avatar" class="big-avatar" src="">
  <h2 id="call-name"></h2>
  <div id="status">Llamando...</div>
  <div id="timer" class="timer" style="display:none">00:00</div>
  <button class="btn-circle hangup" id="hangup">
    <svg width="38" height="38" fill="#fff" viewBox="0 0 24 24"><path d="M12 9c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm5 13.59L15.59 21 12 17.41 8.41 21 7 19.59 10.59 16 7 12.41 8.41 11 12 14.59 15.59 11 17 12.41 13.41 16 17 19.59 15.59 21z"/></svg>
  </button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const user = JSON.parse(localStorage.getItem('currentUser'));
  if (!user) location.href = '/';

  let pc = null;
  let callId = null;
  let timerInt = null;

  socket.emit('user-login', user);

  socket.on('users-updated', list => {
    const div = document.getElementById('users');
    div.innerHTML = '';
    list.filter(u => u.id !== user.id).forEach(u => {
      const el = document.createElement('div');
      el.className = 'user';
      el.innerHTML = `
        <img src="${u.avatar}" onerror="this.src='/default-avatar.png'">
        <div>
          <div style="font-weight:600">${u.name}</div>
          <small style="color:#94a3b8">En l√≠nea</small>
        </div>
        <button class="call-btn" onclick="startCall(\( {u.id},' \){u.name}','${u.avatar}')">
          <svg width="24" height="24" fill="#fff" viewBox="0 0 24 24"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57a1 1 0 0 0-1.02.24l-2.2 2.2a15 15 0 0 1-6.59-6.59l2.2-2.2a1 1 0 0 0 .25-1.02A11 11 0 0 1 8.5 4a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1c0 9.39 7.61 17 17 17a1 1 0 0 0 1-1v-3.5a1 1 0 0 0-1-1z"/></svg>
        </button>`;
      div.appendChild(el);
    });
  });

  window.startCall = async (id, name, avatar) => {
    pc = new RTCPeerConnection({
      iceServers: [
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'},
        {urls:['turn:relay1.expressturn.com:3480?transport=tcp','turns:relay1.expressturn.com:5349'],
         username:'000000002079624655', credential:'IDRwv6Pt/dZCoN7zXyU8lpCpE4w='}
      ]
    });

    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    pc.ontrack = e => document.getElementById('remote').srcObject = e.streams[0];
    pc.onicecandidate = e => e.candidate && socket.emit('webrtc-ice-candidate', {toSocketId: id, candidate: e.candidate, callId});

    socket.emit('initiate-call', {fromUser: user, toUserId: id});
    callId = Date.now();
    setupCallScreen(name, avatar, 'Llamando...');
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('webrtc-offer', {toSocketId: id, offer, callId});
  };

  socket.on('incoming-call', data => {
    document.getElementById('in-avatar').src = data.fromUser.avatar || '/default-avatar.png';
    document.getElementById('in-name').textContent = data.fromUser.name;
    callId = data.callId;
    document.getElementById('incoming').classList.add('active');
  });

  socket.on('webrtc-offer', async data => {
    pc = new RTCPeerConnection({iceServers: [/* mismo que arriba */]});
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    pc.ontrack = e => document.getElementById('remote').srcObject = e.streams[0];
    pc.onicecandidate = e => e.candidate && socket.emit('webrtc-ice-candidate', {toSocketId: data.from, candidate: e.candidate, callId});
    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('webrtc-answer', {toSocketId: data.from, answer, callId});
    setupCallScreen(data.fromUser.name, data.fromUser.avatar, 'Conectando...');
  });

  socket.on('webrtc-answer', data => pc.setRemoteDescription(data.answer));
  socket.on('webrtc-ice-candidate', data => data.candidate && pc.addIceCandidate(data.candidate));

  socket.on('call-connected', () => {
    document.getElementById('status').style.display = 'none';
    document.getElementById('timer').style.display = 'block';
    startTimer();
  });

  function setupCallScreen(name, avatar, status) {
    document.getElementById('call-avatar').src = avatar || '/default-avatar.png';
    document.getElementById('call-name').textContent = name;
    document.getElementById('status').textContent = status;
    document.getElementById('call').classList.add('active');
  }

  function startTimer() {
    let s = 0;
    timerInt = setInterval(() => {
      s++;
      const m = String(Math.floor(s/60)).padStart(2,'0');
      document.getElementById('timer').textContent = `\( {m}: \){String(s%60).padStart(2,'0')}`;
    }, 1000);
  }

  function endCall() {
    if (timerInt) clearInterval(timerInt);
    if (pc) pc.close();
    socket.emit('call-ended', {callId});
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  }

  document.getElementById('accept').onclick = () => {
    socket.emit('call-accepted', {callId});
    document.getElementById('incoming').classList.remove('active');
    document.getElementById('call').classList.add('active');
    startTimer();
  };
  document.getElementById('reject').onclick = () => {
    socket.emit('call-rejected', {callId});
    endCall();
  };
  document.getElementById('hangup').onclick = endCall;
</script>
</body>
</html>