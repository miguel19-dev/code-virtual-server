<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"content="width=device-width, initial-scale=1.0"/>
  <title>CallApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;color:#1a202c}
    .screen,.call-screen{display:none;min-height:100vh;padding:20px}
    .active{display:flex;flex-direction:column}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;color:white}
    .header h2{font-size:1.5em;font-weight:600}
    .btn-icon{background:rgba(255,255,255,0.2);border:none;padding:12px;border-radius:12px;color:white;cursor:pointer}
    .btn-icon:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}

    .users-container{display:grid;gap:15px;max-width:500px;margin:0 auto}
    .user-card{background:white;border-radius:15px;padding:18px;display:flex;align-items:center;box-shadow:0 6px 20px rgba(0,0,0,0.12);transition:.3s}
    .user-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,0.18)}
    .user-avatar{width:52px;height:52px;border-radius:50%;object-fit:cover;margin-right:15px}
    .user-name{font-weight:600}
    .user-status{font-size:0.85em;color:#718096;display:flex;align-items:center;gap:6px;margin-top:4px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#48bb78}
    .btn-call{background:#667eea;color:white;border:none;padding:12px;border-radius:12px;cursor:pointer}
    .btn-call:hover{background:#5a6fd8}

    .call-screen{position:fixed;inset:0;background:#0f172a;display:flex;align-items:center;justify-content:center;z-index:1000}
    .call-container{text-align:center;color:white}
    .call-avatar-big{width:130px;height:130px;border-radius:50%;object-fit:cover;margin-bottom:20px;border:4px solid #667eea}
    .call-name{font-size:1.7em;font-weight:600;margin:10px 0}
    .call-status{font-size:1.2em;color:#94a3b8;margin:15px 0}
    .call-timer{font-size:2.2em;color:#48bb78;margin:30px 0;display:none}
    .call-buttons{display:flex;gap:30px;justify-content:center;margin-top:40px}
    .btn-circle{width:70px;height:70px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .btn-answer{background:#48bb78}
    .btn-reject,.btn-end{background:#e53e3e;color:white}
    .btn-circle:hover{transform:scale(1.1)}

    .notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:14px 28px;border-radius:12px;color:white;font-weight:500;z-index:2000;display:none}
    .notification.active{display:block;animation:n 0.4s}
    .notification.success{background:#4299e1}
    .notification.success{background:#48bb78}
    .notification.error{background:#e53e3e}
    @keyframes n{from{opacity:0;transform:translate(-50%,-20px)}}

    .empty-state{text-align:center;color:white;padding:60px 20px}
    .empty-state svg{width:80px;height:80px;opacity:0.7;margin-bottom:20px}
  </style>
</head>
<body>

<audio id="local-audio" muted playsinline></audio>
<audio id="remote-audio" autoplay playsinline></audio>
<div id="notification" class="notification"></div>

<!-- Pantalla principal -->
<div id="main-screen" class="screen active">
  <div class="header">
    <h2>Usuarios</h2>
    <div style="display:flex;gap:12px">
      <button id="show-history" class="btn-icon">Historial</button>
      <button id="logout-btn" class="btn-icon">Salir</button>
    </div>
  </div>
  <div id="users-container" class="users-container"></div>
</div>

<!-- Historial -->
<div id="history-screen" class="screen">
  <div class="header">
    <button id="back-to-main" class="btn-icon">Atrás</button>
    <h2>Historial</h2>
    <div style="width:48px"></div>
  </div>
  <div id="call-history" style="max-width:600px;margin:0 auto;background:white;border-radius:15px;padding:20px;max-height:75vh;overflow-y:auto"></div>
</div>

<!-- Llamada entrante -->
<div id="incoming-call-screen" class="call-screen">
  <div class="call-container">
    <img id="incoming-avatar" class="call-avatar-big" src="/default-avatar.png" alt="Avatar">
    <div class="call-name" id="incoming-name">Usuario</div>
    <div class="call-status">Llamada entrante...</div>
    <div class="call-buttons">
      <button id="answer-call" class="btn-circle btn-answer">Contestar</button>
      <button id="reject-call" class="btn-circle btn-reject">Rechazar</button>
    </div>
  </div>
</div>

<!-- Llamada en curso -->
<div id="outgoing-call-screen" class="call-screen">
  <div class="call-container">
    <img id="outgoing-avatar" class="call-avatar-big" src="/default-avatar.png" alt="Avatar">
    <div class="call-name" id="outgoing-name">Conectando...</div>
    <div class="call-status" id="call-status">Llamando...</div>
    <div id="call-timer" class="call-timer">00:00</div>
    <div class="call-buttons">
      <button id="end-call" class="btn-circle btn-end">Colgar</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  class CallApp {
    constructor() {
      this.socket = io();
      this.currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!this.currentUser) location.href = '/';
      this.activeCall = null;
      this.callStartTime = null;
      this.callTimer = null;
      this.peerConnection = null;
      this.localStream = null;

      this.socket.emit('user-login', this.currentUser);
      this.initEvents();
    }

    initEvents() {
      document.getElementById('show-history').onclick = () => this.showHistory();
      document.getElementById('back-to-main').onclick = () => this.showScreen('main-screen');
      document.getElementById('logout-btn').onclick = () => this.logout();
      document.getElementById('answer-call').onclick = () => this.answerCall();
      document.getElementById('reject-call').onclick = () => this.endCall();
      document.getElementById('end-call').onclick = () => this.endCall();

      this.socket.on('users-updated', u => this.renderUsers(u));
      this.socket.on('incoming-call', d => this.showIncomingCall(d));
      this.socket.on('call-initiated', d => this.onCallInitiated(d));
      this.socket.on('call-connected', () => this.onCallConnected());
      this.socket.on('call-rejected', () => this.endCall('Rechazada'));
      this.socket.on('call-ended', d => this.endCall(d?.duration > 0 ? `Finalizada · ${this.fmt(d.duration)}` : 'Cancelada'));
      this.socket.on('call-error', m => this.notify(m, 'error'));

      this.socket.on('webrtc-offer', d => this.handleOffer(d));
      this.socket.on('webrtc-answer', d => this.handleAnswer(d));
      this.socket.on('webrtc-ice-candidate', d => this.handleICECandidate(d));
    }

    async setupWebRTC() {
      const cfg = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: ['turn:relay1.expressturn.com:3480?transport=tcp', 'turns:relay1.expressturn.com:5349'],
            username: '000000002079624655',
            credential: 'IDRwv6Pt/dZCoN7zXyU8lpCpE4w=' }
        ]
      };
      this.peerConnection = new RTCPeerConnection(cfg);
      this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this.localStream.getTracks().forEach(t => this.peerConnection.addTrack(t, this.localStream));
      document.getElementById('local-audio').srcObject = this.localStream;

      this.peerConnection.ontrack = e => document.getElementById('remote-audio').srcObject = e.streams[0];
      this.peerConnection.onicecandidate = e => {
        if (e.candidate && this.activeCall) {
          this.socket.emit('webrtc-ice-candidate', { to: this.activeCall.targetSocketId, candidate: e.candidate, callId: this.activeCall.callId });
        }
      };
      this.peerConnection.onconnectionstatechange = () => {
        if (this.peerConnection.connectionState === 'connected') this.onCallConnected();
      };
    }

    async initiateCall(userId) {
      await this.setupWebRTC();
      this.activeCall = { callId: Date.now(), targetSocketId: userId };
      this.socket.emit('initiate-call', { fromUser: this.currentUser, toUserId: userId, callType: 'audio' });
      this.showScreen('outgoing-call-screen');
      this.setStatus('Llamando...');
    }

    onCallInitiated(data) {
      this.activeCall = { ...this.activeCall, ...data, targetSocketId: data.to.socketId };
      this.setAvatar(data.to.avatar);
      document.getElementById('outgoing-name').textContent = data.to.name;
      this.createOffer();
    }

    async createOffer() {
      const offer = await this.peerConnection.createOffer();
      await this.peerConnection.setLocalDescription(offer);
      this.socket.emit('webrtc-offer', { to: this.activeCall.targetSocketId, offer, callId: this.activeCall.callId });
      this.setStatus('Conectando...');
    }

    async handleOffer(data) {
      await this.setupWebRTC();
      this.activeCall = { callId: data.callId, targetSocketId: data.from, fromUser: data.fromUser };
      this.setAvatar(data.fromUser.avatar);
      document.getElementById('outgoing-name').textContent = data.fromUser.name;
      this.showScreen('outgoing-call-screen');
      this.setStatus('Conectando...');

      await this.peerConnection.setRemoteDescription(data.offer);
      const answer = await this.peerConnection.createAnswer();
      await this.peerConnection.setLocalDescription(answer);
      this.socket.emit('webrtc-answer', { to: data.from, answer, callId: data.callId });
    }

    async handleAnswer(data) { await this.peerConnection.setRemoteDescription(data.answer); }
    async handleICECandidate(data) { if (data.candidate) await this.peerConnection.addIceCandidate(data.candidate); }

    answerCall() {
      this.socket.emit('answer-call', { callId: this.activeCall.callId });
      this.showScreen('outgoing-call-screen');
      this.setStatus('Conectando...');
    }

    onCallConnected() {
      document.getElementById('call-status').style.display = 'none';
      document.getElementById('call-timer').style.display = 'block';
      this.startTimer();
      this.notify('Conectado', 'success');
    }

    endCall(msg = 'Llamada finalizada') {
      if (this.activeCall) this.socket.emit('end-call', { callId: this.activeCall.callId });
      this.cleanup();
      this.notify(msg, msg.includes('Rechazada') ? 'error' : 'info');
    }

    cleanup() {
      if (this.callTimer) clearInterval(this.callTimer);
      if (this.localStream) this.localStream.getTracks().forEach(t => t.stop());
      if (this.peerConnection) this.peerConnection.close();
      this.localStream = this.peerConnection = this.activeCall = null;
      this.showScreen('main-screen');
    }

    startTimer() {
      this.callStartTime = Date.now();
      this.callTimer = setInterval(() => {
        const diff = Math.floor((Date.now() - this.callStartTime) / 1000);
        const m = String(Math.floor(diff / 60)).padStart(2, '0');
        const s = String(diff % 60).padStart(2, '0');
        document.getElementById('call-timer').textContent = `\( {m}: \){s}`;
      }, 1000);
    }

    setStatus(text) { document.getElementById('call-status').textContent = text; }
    setAvatar(src) {
      const url = src || '/default-avatar.png';
      document.getElementById('outgoing-avatar').src = url;
      document.getElementById('incoming-avatar').src = url;
    }

    showIncomingCall(data) {
      this.activeCall = { callId: data.callId, fromUser: data.fromUser };
      this.setAvatar(data.fromUser.avatar);
      document.getElementById('incoming-name').textContent = data.fromUser.name;
      this.showScreen('incoming-call-screen');
    }

    showScreen(id) {
      document.querySelectorAll('.screen,.call-screen').forEach(el => el.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    notify(msg, type='info') {
      const n = document.getElementById('notification');
      n.textContent = msg;
      n.className = `notification ${type} active`;
      setTimeout(() => n.classList.remove('active'), 3000);
    }

    renderUsers(users) {
      const c = document.getElementById('users-container');
      if (!users?.length) {
        c.innerHTML = `<div class="empty-state"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><h3>Nadie conectado</h3></div>`;
        return;
      }
      c.innerHTML = '';
      users.forEach(u => {
        if (u.id === this.currentUser.id) return;
        const d = document.createElement('div');
        d.className = 'user-card';
        d.innerHTML = `
          <img src="\( {u.avatar || '/default-avatar.png'}" class="user-avatar" alt=" \){u.name}">
          <div style="flex:1">
            <div class="user-name">${u.name}</div>
            <div class="user-status"><div class="status-dot"></div>En línea</div>
          </div>
          <button class="btn-call" onclick="app.initiateCall('${u.id}')">Llamar</button>
        `;
        c.appendChild(d);
      });
    }

    showHistory() {
      fetch('/api/call-history')
        .then(r => r.json())
        .then(h => {
          const c = document.getElementById('call-history');
          if (!h.length) {
            c.innerHTML = '<div class="empty-state" style="color:#718096"><h3>Sin historial</h3></div>';
            this.showScreen('history-screen');
            return;
          }
          c.innerHTML = '';
          h.forEach(call => {
            const i = document.createElement('div');
            i.style.cssText = 'display:flex;align-items:center;padding:15px;border-bottom:1px solid #eee';
            i.innerHTML = `
              <img src="${call.from.avatar || '/default-avatar.png'}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:15px">
              <div style="flex:1">
                <div style="font-weight:600">${call.from.name}</div>
                <div style="font-size:0.85em;color:#718096">${new Date(call.startTime).toLocaleString()}</div>
              </div>
              <div style="color:${call.status==='completed'?'#48bb78':'#e53e3e'}">
                \( {call.status==='completed'?'Completada':call.status==='rejected'?'Rechazada':'Perdida'} \){call.duration? '· '+this.fmt(call.duration):''}
              </div>`;
            c.appendChild(i);
          });
          this.showScreen('history-screen');
        });
    }

    fmt(s) {
      const m = Math.floor(s/60).toString().padStart(2,'0');
      return `\( {m}: \){(s%60).toString().padStart(2,'0')}`;
    }

    logout() {
      this.cleanup();
      localStorage.removeItem('currentUser');
      location.href = '/';
    }
  }

  const app = new CallApp();
  document.addEventListener('DOMContentLoaded', () => app = new CallApp());
</script>
</body>
</html>